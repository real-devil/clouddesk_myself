<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="./layui-master/src/css/layui.css"  media="all">
		<link rel="stylesheet" href="./file/css/header.css" rel="stylesheet">
		<style type="text/css">
			.checkss input{
				margin-left: 10px;
			}
			button{
				border: none;
				background-color: rgb(22,155,213);
				color: white;
				border-radius: 4px;
				padding: 3px 10px;
				margin-left: 10px;
			}
			#table_box{
				text-align: center;
			}
			 tr th{
				 background: rgb(0,150,136);
				 color: white;
				 text-align: center!important;
			 } 
			input[type="checkbox"]{
				display: inline-block!important;
				margin-left: 10px;
			}
		 </style>
	</head>
	<body class="layui-layout-body">
		<div class="layui-layout layui-layout-admin">
		   <!-- 网页头部导航条 -->
		   <div class="layui-header">
				<!-- 网页头部左侧-页面logo -->
				<div class="layui-logo">
					<h2>移动大数据云平台</h2>
					<p>MobileBigData_CloudPlatform</p>
				</div>
				<!-- 网页头部右侧-用户信息及退出 -->
				<ul class="layui-nav layui-layout-right">
				  <li class="layui-nav-item">
					<a href="javascript:;">
					  欢迎你！<span id="username">贤心</span>
					</a>
					<dl class="layui-nav-child">
					  <dd><a href="">用户信息</a></dd>
					</dl>
				  </li>
				  <li class="layui-nav-item"><a href="">退出</a></li>
				</ul>
		  </div>
		  
		   <!-- 网页左侧导航条 -->
           <div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree"  lay-filter="test">
  			<li class="layui-nav-item"><a class="glyphicon glyphicon-search" href="./query.html">&nbsp;数据查询</a></li>
  				  <li class="layui-nav-item"><a class="glyphicon glyphicon-download-alt" href="./data_download.html">&nbsp;数据下载</a></li>
        <li class="layui-nav-item">
          <a class="glyphicon glyphicon-open" href="javascript:;">&nbsp;数据上传</a>
          <dl class="layui-nav-child">
            <dd><a href="./upload_data.html">上传数据</a></dd>
            <dd><a href="./upload_record.html">上传记录</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a class="glyphicon glyphicon-list-alt" href="javascript:;">&nbsp;审核处理</a>
          <dl class="layui-nav-child">
            <dd><a href="./upload_check.html">上传审核</a></dd>
            <dd><a href="./download_check.html">下载审核</a></dd>
            <dd><a href="./register_check.html">注册审核</a></dd>
          </dl>
        </li>
  				<li class="layui-nav-item">
  				  <a class="glyphicon glyphicon-file" href="javascript:;">&nbsp;权限管理</a>
  				  <dl class="layui-nav-child">
  				    <dd><a href="./role_empower.html">角色授权</a></dd>
  				    <dd><a href="./jurisdiction_empower.html">权限授权</a></dd>
  				    <dd><a href="./data_empower.html">数据授权</a></dd>
  				  </dl>
  				</li>
  				<li class="layui-nav-item">
  				  <a class="glyphicon glyphicon-user" href="javascript:;">&nbsp;关于用户</a>
  				  <dl class="layui-nav-child">
  				    <dd><a href="./persona_homepage.html">个人主页</a></dd>
  				    <dd><a href="./login.html">注销退出</a></dd>
  				  </dl>
  				</li>
      </ul>
    </div>
  </div>
		  
		   <!-- 网页主体内容 -->
		   <div class="layui-body">
		       <!-- 内容主体区域 -->
		       <div style="padding: 15px;">
				<div class="layui-form">
				   <table class="layui-table" id="table_box">
						<colgroup>
						  <col width="100">
						  <col width="250">
						  <col width="100">
						</colgroup>
						<thead>
						  <tr>
							<th>用户名称</th> 
							<th>用户角色</th>
							<th>授权操作</th>
						  </tr> 
						</thead>
						<tbody id="tab_body">
						  <tr>
							<td>成龙</td>
							<td class="checkss">
								<input type="checkbox" name="self_query" value="市场部领导" />&nbsp;<span>市场部领导</span>
								<input type="checkbox" name="query_result" value="营销部领导"/>&nbsp;<span>营销部领导</span>
								<input type="checkbox" name="upload_data" value="营销部员工"/>&nbsp;<span>营销部员工</span>
							</td>
							<td>
							   <button class="empower">授权</button>
							</td>
						  </tr>
						  <tr>
							<td>黎明</td>
							<td class="checkss">
								<input type="checkbox" name="self_query" value="市场部领导" />&nbsp;<span>市场部领导</span>
								<input type="checkbox" name="query_result" value="营销部领导"/>&nbsp;<span>营销部领导</span>
								<input type="checkbox" name="upload_data" value="营销部员工"/>&nbsp;<span>营销部员工</span>
							</td>
							<td>
							   <button class="empower">授权</button>
							</td>
						  </tr>
						</tbody>
		            </table>					
				</div>
		  </div>
		   </div>
	    
		</div>
		
	<script src="./layui-master/src/layui.js" charset="utf-8"></script>
	<script src="file/jquery-1.11.3.min.js"></script>
	<script src="./file/js/header.js"></script>
	<script type="text/javascript">
		// (1)ajax加载数据到页面上去,实现把用户所属角色复选框为选中状态，其他角色正常
		var xhr = new XMLHttpRequest();
		xhr.open('get','./role_em.php');
		xhr.onreadystatechange = function(){
			if (xhr.readyState==4&&xhr.status==200) {
				var arr = JSON.parse(xhr.responseText);

				var str = "";
				for (var i = 0; i < arr.length; i++) {
					str += '<td>'+arr[i].user+'</td>';
					str += '<td>';
					//遍历用户所属角色数组，并把复选框勾选
					for (var j = 0; j < arr[i].user_role.length; j++) {
						str += '<input type="checkbox" name="self_query" value="'+arr[i].user_role[j]+'" checked/>&nbsp;<span>'+arr[i].user_role[j]+'</span>'
					}

					//所有角色数组 和 用户所属角色数组 去重筛选
					var tempArray1 = [];//临时数组1
					var tempArray2 = [];//临时数组2
					for(var m=0;m<arr[i].user_role.length;m++){
    					tempArray1[arr[i].user_role[m]]=true;
					}
					for(var k=0;k<arr[i].role.length;k++){
    					if(!tempArray1[arr[i].role[k]]){
        					tempArray2.push(arr[i].role[k]);
    					}
					}
					for (var p = 0; p < tempArray2.length; p++) {						
						str += '<input type="checkbox" name="self_query" value="'+tempArray2[p]+'"/>&nbsp;<span>'+tempArray2[p]+'</span>'
					}

					str += '</td>';
					str += '<td><button class="empower">授权</button></td>';
					var m = document.createElement("tr")
					m.innerHTML = str;
					document.getElementById('tab_body').appendChild(m);
					str = "";  //每循环一次，就清空一次html
				}

				//(2)点击授权按钮把用户名称和选中的复选框发送到后台
				$('.empower').click(function(){
					var username = $(this).closest("tr").find("td").eq(0).text();
					var user_role = $(this).closest("tr").find("td input[type='checkbox']:checked").val();
					
		
					var checkID = [];//定义一个空数组 
					// //把所有被选中的复选框的值存入数组
					 $(this).closest("tr").find("td input[type='checkbox']:checked").each(function(i){
						checkID[i] =$(this).val();
					 });
					$.ajax({
						url:"./role_but.php",
						type:"get",
						data:"username="+username+"&user_role="+checkID,
						success:function(data){
							console.log(data);
						}
					})
				});
			}	
		}
		xhr.send();

		
		
	</script>
	</body>
</html>
